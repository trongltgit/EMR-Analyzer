<script>
    document.getElementById("analyze-button").addEventListener("click", async () => {
        const fileInput = document.getElementById("upload");
        if (!fileInput.files.length) {
            alert("Vui lòng chọn một tệp!");
            return;
        }
        const formData = new FormData();
        formData.append("image", fileInput.files[0]);

        const resultMessage = document.getElementById("result-message");
        resultMessage.innerText = "Đang phân tích...";
        try {
            const res = await fetch("/predict", { method: "POST", body: formData });
            const contentType = res.headers.get("content-type");
            if (!res.ok) {
                let errorMessage = "Lỗi không xác định.";
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    const errorData = await res.json();
                    errorMessage = errorData.error || res.statusText;
                } else {
                    errorMessage = await res.text();
                }
                resultMessage.innerText = `Lỗi: ${errorMessage}`;
                return;
            }
            if (contentType && contentType.indexOf("application/json") !== -1) {
                const data = await res.json();
                resultMessage.innerText = `Kết quả: ${data.classification} (điểm số: ${data.score.toFixed(3)})`;
            } else {
                resultMessage.innerText = "Lỗi: Phản hồi không phải JSON.";
            }
        } catch (e) {
            resultMessage.innerText = `Lỗi mạng: ${e.message}`;
        }
    });

    document.getElementById("ping-btn").addEventListener("click", async () => {
        const pingResult = document.getElementById("ping-result");
        try {
            const res = await fetch("/ping");
            const data = await res.json();
            pingResult.innerText = "Ping thành công: " + JSON.stringify(data);
        } catch (e) {
            pingResult.innerText = "Ping thất bại: " + e.message;
        }
    });
</script>
